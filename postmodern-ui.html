<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>POST/MODERN — Interface System</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;700&family=Space+Grotesk:wght@400;500;600;700&family=IBM+Plex+Sans+Condensed:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    :root {
      /* Primary accent - set by picker */
      --primary-h: 18;
      --primary-s: 100%;
      --primary-l: 60%;
      --primary: hsl(var(--primary-h), var(--primary-s), var(--primary-l));
      
      /* Mode-derived values - computed by JS */
      --bg-h: 18;
      --bg-s: 8%;
      --bg-l: 10%;
      --fg-h: 18;
      --fg-s: 15%;
      --fg-l: 85%;
      --border-h: 18;
      --border-s: 10%;
      --border-l: 22%;
      
      /* Surface hierarchy - computed from bg, with controllable saturation */
      --surface-s: var(--bg-s);
      --background: hsl(var(--bg-h), var(--bg-s), var(--bg-l));
      --surface-1: hsl(var(--bg-h), var(--surface-s), calc(var(--bg-l) + var(--surface-step) * 1));
      --surface-2: hsl(var(--bg-h), var(--surface-s), calc(var(--bg-l) + var(--surface-step) * 2));
      --surface-3: hsl(var(--bg-h), var(--surface-s), calc(var(--bg-l) + var(--surface-step) * 3));
      --surface-step: 3%;
      
      /* Text hierarchy - computed from fg with minimum contrast guarantees */
      --text-primary: hsl(var(--fg-h), var(--fg-s), var(--fg-l));
      --text-secondary: hsl(var(--fg-h), calc(var(--fg-s) * 0.8), calc(var(--fg-l) * 0.9));
      --text-tertiary: hsl(var(--fg-h), calc(var(--fg-s) * 0.6), calc(var(--fg-l) * 0.7));
      
      /* Border/divider - now computed separately for proper contrast */
      --border: hsl(var(--border-h), var(--border-s), var(--border-l));
      
      /* Functional accents - shift based on mode */
      --status-active: hsl(145, 65%, 45%);
      --status-warning: hsl(40, 85%, 55%);
      --status-info: hsl(210, 70%, 55%);
      
      /* DPI scaling - base value, overridden by body class */
      --dither-scale: 1;
      
      /* Type scale */
      --text-xs: 0.75rem;
      --text-sm: 0.875rem;
      --text-base: 1rem;
      --text-lg: 1.125rem;
      --text-xl: 1.5rem;
      --text-2xl: 2rem;
      --text-3xl: 3rem;
      
      /* Spacing */
      --space-1: 0.25rem;
      --space-2: 0.5rem;
      --space-3: 0.75rem;
      --space-4: 1rem;
      --space-6: 1.5rem;
      --space-8: 2rem;
      --space-12: 3rem;
    }

    /* DPI Presets - two density options */
    .dpi-fine { 
      --dither-scale: 1; 
      --dither-size: 4px;
    }
    .dpi-retina { 
      --dither-scale: 0.5; 
      --dither-size: 2px;
    }
    
    /* Default dither size */
    body {
      --dither-size: 4px;
    }

    /* 
     * Ordered dithering using 4x4 Bayer matrix pattern
     * Pattern creates 17 levels of apparent transparency through dot placement
     * Each density level uses a different threshold of the Bayer matrix
     */
    
    /* Dither pattern containers */
    .dither-pattern {
      position: relative;
      overflow: hidden;
    }
    
    .dither-pattern::after {
      content: '';
      position: absolute;
      inset: 0;
      pointer-events: none;
      image-rendering: pixelated;
      image-rendering: crisp-edges;
    }
    
    /* ~25% density dither */
    .dither-25::after {
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='4' height='4'%3E%3Crect x='0' y='0' width='1' height='1' fill='%23ffffff'/%3E%3C/svg%3E");
      background-size: var(--dither-size) var(--dither-size);
    }
    
    /* ~50% density dither (classic checkerboard) */
    .dither-50::after {
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='2' height='2'%3E%3Crect x='0' y='0' width='1' height='1' fill='%23ffffff'/%3E%3Crect x='1' y='1' width='1' height='1' fill='%23ffffff'/%3E%3C/svg%3E");
      background-size: var(--dither-size) var(--dither-size);
    }
    
    /* ~75% density dither */
    .dither-75::after {
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='4' height='4'%3E%3Crect x='0' y='0' width='4' height='4' fill='%23ffffff'/%3E%3Crect x='0' y='0' width='1' height='1' fill='%23000000'/%3E%3C/svg%3E");
      background-size: var(--dither-size) var(--dither-size);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'IBM Plex Sans Condensed', sans-serif;
      background: var(--background);
      color: var(--text-primary);
      min-height: 100vh;
      line-height: 1.5;
      transition: background 0.4s ease, color 0.4s ease;
    }

    /* ================================
       CONTROL PANEL
    ================================ */
    
    .control-panel {
      position: fixed;
      top: var(--space-4);
      right: var(--space-4);
      background: var(--surface-1);
      border: 1px solid var(--border);
      padding: var(--space-4);
      z-index: 1000;
      width: 300px;
      max-height: calc(100vh - var(--space-8));
      overflow-y: auto;
      transition: background 0.4s ease, border-color 0.4s ease;
    }

    .control-panel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: var(--space-4);
      padding-bottom: var(--space-3);
      border-bottom: 1px solid var(--border);
    }

    .control-panel-title {
      font-family: 'JetBrains Mono', monospace;
      font-size: var(--text-xs);
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--text-tertiary);
    }

    .control-toggle {
      background: var(--surface-2);
      border: 1px solid var(--border);
      color: var(--text-tertiary);
      padding: var(--space-1) var(--space-2);
      font-family: 'JetBrains Mono', monospace;
      font-size: 10px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .control-toggle:hover {
      background: var(--surface-3);
      color: var(--text-secondary);
    }

    .control-section {
      margin-bottom: var(--space-6);
    }

    .control-section-title {
      font-family: 'JetBrains Mono', monospace;
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--primary);
      margin-bottom: var(--space-3);
    }

    .control-label {
      font-size: var(--text-xs);
      color: var(--text-tertiary);
      margin-bottom: var(--space-2);
      display: block;
    }

    /* ================================
       MODE SELECTOR (Dark/Twilight/Light)
    ================================ */
    
    .mode-selector {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 2px;
      background: var(--border);
      padding: 2px;
      margin-bottom: var(--space-4);
    }

    .mode-option {
      position: relative;
      padding: var(--space-3) var(--space-2);
      text-align: center;
      cursor: pointer;
      transition: all 0.2s ease;
      border: none;
      font-family: 'JetBrains Mono', monospace;
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .mode-option.dark {
      background: hsl(20, 8%, 12%);
      color: hsl(20, 15%, 75%);
    }

    .mode-option.twilight {
      background: linear-gradient(135deg, hsl(30, 25%, 45%) 0%, hsl(220, 30%, 35%) 100%);
      color: hsl(40, 30%, 90%);
    }

    .mode-option.light {
      background: hsl(40, 20%, 92%);
      color: hsl(20, 15%, 25%);
    }

    .mode-option:hover {
      filter: brightness(1.1);
    }

    .mode-option.selected::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: var(--primary);
    }

    .mode-option-label {
      display: block;
      font-weight: 600;
      margin-bottom: 2px;
    }

    .mode-option-time {
      font-size: 9px;
      opacity: 0.7;
    }

    /* Mode preview strip */
    .mode-preview {
      display: flex;
      height: 40px;
      margin-bottom: var(--space-3);
      border: 1px solid var(--border);
      overflow: hidden;
    }

    .mode-preview-bg {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: 'JetBrains Mono', monospace;
      font-size: 9px;
      transition: all 0.4s ease;
    }

    .mode-preview-fg {
      padding: var(--space-2);
      display: flex;
      flex-direction: column;
      justify-content: center;
      gap: 2px;
    }

    .mode-preview-swatch {
      width: 12px;
      height: 6px;
      transition: all 0.4s ease;
    }

    /* Harmony indicator */
    .harmony-info {
      background: var(--surface-2);
      padding: var(--space-3);
      font-family: 'JetBrains Mono', monospace;
      font-size: 10px;
      margin-bottom: var(--space-3);
    }

    .harmony-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: var(--space-1);
      color: var(--text-tertiary);
    }

    .harmony-row:last-child {
      margin-bottom: 0;
    }

    .harmony-value {
      color: var(--text-secondary);
    }

    /* ================================
       STEPPED HSV COLOR PICKER
    ================================ */
    
    .hue-grid {
      display: grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 2px;
      margin-bottom: var(--space-3);
    }

    .hue-step {
      aspect-ratio: 2;
      cursor: pointer;
      border: 2px solid transparent;
      transition: all 0.15s ease;
      position: relative;
    }

    .hue-step:hover {
      transform: scale(1.1);
      z-index: 1;
    }

    .hue-step.selected {
      border-color: var(--text-primary);
      box-shadow: 0 0 0 1px var(--background);
    }

    .sv-grid {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      grid-template-rows: repeat(4, 1fr);
      gap: 2px;
      margin-bottom: var(--space-3);
    }

    .sv-step {
      aspect-ratio: 2.5;
      cursor: pointer;
      border: 2px solid transparent;
      transition: all 0.15s ease;
    }

    .sv-step:hover {
      transform: scale(1.05);
      z-index: 1;
    }

    .sv-step.selected {
      border-color: var(--text-primary);
      box-shadow: 0 0 0 1px var(--background);
    }

    /* Saturation-only grid for background */
    .sat-grid {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 2px;
      margin-bottom: var(--space-3);
    }

    .sat-step {
      aspect-ratio: 3;
      cursor: pointer;
      border: 2px solid transparent;
      transition: all 0.15s ease;
    }

    .sat-step:hover {
      transform: scale(1.05);
      z-index: 1;
    }

    .sat-step.selected {
      border-color: var(--text-primary);
      box-shadow: 0 0 0 1px var(--background);
    }

    /* Lightness grid for background */
    .light-grid {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 2px;
      margin-bottom: var(--space-3);
    }

    .light-step {
      aspect-ratio: 3;
      cursor: pointer;
      border: 2px solid transparent;
      transition: all 0.15s ease;
    }

    .light-step:hover {
      transform: scale(1.05);
      z-index: 1;
    }

    .light-step.selected {
      border-color: var(--text-primary);
      box-shadow: 0 0 0 1px var(--background);
    }

    .color-preview {
      display: flex;
      align-items: center;
      gap: var(--space-3);
      padding: var(--space-3);
      background: var(--surface-2);
      margin-bottom: var(--space-2);
      transition: background 0.4s ease;
    }

    .color-preview.compact {
      padding: var(--space-2);
    }

    .color-swatch {
      width: 32px;
      height: 32px;
      background: var(--primary);
      border: 1px solid var(--border);
      flex-shrink: 0;
    }

    .color-preview.compact .color-swatch {
      width: 24px;
      height: 24px;
    }

    .color-values {
      font-family: 'JetBrains Mono', monospace;
      font-size: 11px;
      color: var(--text-tertiary);
    }

    .color-values span {
      display: block;
    }

    .color-hex {
      color: var(--text-secondary);
      font-weight: 500;
    }

    /* ================================
       DPI CONTROLS
    ================================ */
    
    .dpi-options {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: var(--space-2);
    }

    .dpi-option {
      background: var(--surface-2);
      border: 1px solid var(--border);
      padding: var(--space-3);
      text-align: center;
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .dpi-option:hover {
      background: var(--surface-3);
    }

    .dpi-option.selected {
      border-color: var(--primary);
      background: var(--surface-3);
    }

    .dpi-option-label {
      font-family: 'JetBrains Mono', monospace;
      font-size: 11px;
      font-weight: 600;
      color: var(--text-secondary);
      display: block;
      margin-bottom: var(--space-1);
    }

    .dpi-option-desc {
      font-size: 10px;
      color: var(--text-tertiary);
    }

    .dpi-option.selected .dpi-option-label {
      color: var(--primary);
    }

    .dpi-preview {
      margin-top: var(--space-3);
      padding: var(--space-3);
      background: var(--surface-2);
      transition: background 0.4s ease;
    }

    .dpi-preview-label {
      font-size: 10px;
      color: var(--text-tertiary);
      margin-bottom: var(--space-2);
      font-family: 'JetBrains Mono', monospace;
    }

    .dpi-preview-bar {
      height: 24px;
      background: var(--surface-3);
      position: relative;
      overflow: hidden;
      transition: background 0.4s ease;
    }

    .dpi-preview-fill {
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 70%;
      background: var(--primary);
    }

    .dpi-preview-dither {
      position: absolute;
      right: 0;
      top: 0;
      bottom: 0;
      width: 50%;
    }

    /* ================================
       INTERFACE LAYOUT
    ================================ */
    
    .interface {
      display: grid;
      grid-template-columns: 220px 1fr 280px;
      grid-template-rows: auto 1fr auto;
      min-height: 100vh;
      gap: 1px;
      background: var(--border);
      margin-right: 320px;
      transition: background 0.4s ease;
    }

    /* ================================
       HEADER
    ================================ */
    
    .header {
      grid-column: 1 / -1;
      background: var(--surface-1);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: var(--space-3) var(--space-6);
      border-bottom: 1px solid var(--border);
      transition: background 0.4s ease, border-color 0.4s ease;
    }

    .logo {
      font-family: 'JetBrains Mono', monospace;
      font-weight: 700;
      font-size: var(--text-sm);
      color: var(--primary);
      letter-spacing: 0.05em;
      display: flex;
      align-items: center;
      gap: var(--space-2);
    }

    .logo::before {
      content: '';
      width: 8px;
      height: 8px;
      background: var(--primary);
    }

    .header-status {
      display: flex;
      align-items: center;
      gap: var(--space-6);
      font-size: var(--text-xs);
      font-family: 'JetBrains Mono', monospace;
      color: var(--text-tertiary);
    }

    .status-indicator {
      display: flex;
      align-items: center;
      gap: var(--space-2);
    }

    .status-dot {
      width: 6px;
      height: 6px;
      border-radius: 1px;
      background: var(--status-active);
      animation: pulse 2s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    /* ================================
       NAVIGATION
    ================================ */
    
    .nav {
      background: var(--surface-1);
      padding: var(--space-4);
      display: flex;
      flex-direction: column;
      gap: var(--space-1);
      transition: background 0.4s ease;
    }

    .nav-section {
      margin-bottom: var(--space-4);
    }

    .nav-section-title {
      font-family: 'JetBrains Mono', monospace;
      font-size: var(--text-xs);
      color: var(--text-tertiary);
      text-transform: uppercase;
      letter-spacing: 0.1em;
      padding: var(--space-2) var(--space-3);
      margin-bottom: var(--space-1);
      border-left: 2px solid var(--border);
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: var(--space-3);
      padding: var(--space-2) var(--space-3);
      font-size: var(--text-sm);
      color: var(--text-secondary);
      text-decoration: none;
      transition: all 0.15s ease;
      border-left: 2px solid transparent;
      cursor: pointer;
    }

    .nav-item:hover {
      background: var(--surface-2);
      border-left-color: var(--text-tertiary);
    }

    .nav-item.active {
      background: var(--surface-2);
      border-left-color: var(--primary);
      color: var(--primary);
    }

    .nav-item-icon {
      width: 16px;
      height: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: 'JetBrains Mono', monospace;
      font-size: 10px;
      color: var(--text-tertiary);
    }

    .nav-item.active .nav-item-icon {
      color: var(--primary);
    }

    .nav-badge {
      margin-left: auto;
      font-family: 'JetBrains Mono', monospace;
      font-size: 10px;
      padding: 2px 6px;
      background: var(--surface-3);
      color: var(--text-tertiary);
      transition: background 0.4s ease;
    }

    .nav-badge.active {
      background: var(--primary);
      color: var(--background);
    }

    /* ================================
       MAIN CONTENT
    ================================ */
    
    .main {
      background: var(--background);
      padding: var(--space-6);
      overflow-y: auto;
      transition: background 0.4s ease;
    }

    .content-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      margin-bottom: var(--space-8);
      padding-bottom: var(--space-6);
      border-bottom: 1px solid var(--surface-2);
    }

    .content-title {
      font-family: 'Space Grotesk', sans-serif;
      font-size: var(--text-2xl);
      font-weight: 600;
      color: var(--text-primary);
      letter-spacing: -0.02em;
    }

    .content-subtitle {
      font-size: var(--text-sm);
      color: var(--text-tertiary);
      margin-top: var(--space-2);
    }

    /* ================================
       CARDS
    ================================ */
    
    .card-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: var(--space-4);
      margin-bottom: var(--space-8);
    }

    .card {
      background: var(--surface-1);
      border: 1px solid var(--border);
      padding: var(--space-6);
      position: relative;
      transition: all 0.2s ease;
    }

    .card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: var(--border);
      transition: background 0.2s ease;
    }

    .card:hover::before {
      background: var(--primary);
    }

    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: var(--space-4);
    }

    .card-title {
      font-family: 'Space Grotesk', sans-serif;
      font-size: var(--text-base);
      font-weight: 600;
      color: var(--text-secondary);
    }

    .card-status {
      font-family: 'JetBrains Mono', monospace;
      font-size: 10px;
      padding: var(--space-1) var(--space-2);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .card-status.active {
      background: var(--status-active);
      color: white;
    }

    .card-status.pending {
      background: var(--status-warning);
      color: hsl(30, 50%, 15%);
    }

    .card-status.info {
      background: var(--status-info);
      color: white;
    }

    .card-value {
      font-family: 'JetBrains Mono', monospace;
      font-size: var(--text-3xl);
      font-weight: 700;
      color: var(--primary);
      line-height: 1;
      margin-bottom: var(--space-2);
    }

    .card-label {
      font-size: var(--text-sm);
      color: var(--text-tertiary);
    }

    .card-footer {
      margin-top: var(--space-4);
      padding-top: var(--space-4);
      border-top: 1px solid var(--border);
      font-size: var(--text-xs);
      color: var(--text-tertiary);
      font-family: 'JetBrains Mono', monospace;
    }

    /* ================================
       BUTTONS
    ================================ */
    
    .btn {
      font-family: 'IBM Plex Sans Condensed', sans-serif;
      font-size: var(--text-sm);
      font-weight: 500;
      padding: var(--space-2) var(--space-4);
      border: none;
      cursor: pointer;
      transition: all 0.15s ease;
      text-transform: uppercase;
      letter-spacing: 0.03em;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
    }

    .btn-primary:hover {
      filter: brightness(1.1);
    }

    .btn-secondary {
      background: var(--surface-2);
      color: var(--text-secondary);
      border: 1px solid var(--border);
    }

    .btn-secondary:hover {
      background: var(--surface-3);
      border-color: var(--text-tertiary);
    }

    .btn-ghost {
      background: transparent;
      color: var(--text-tertiary);
      padding: var(--space-2);
    }

    .btn-ghost:hover {
      color: var(--text-secondary);
      background: var(--surface-2);
    }

    /* ================================
       DITHERED ELEMENTS
    ================================ */
    
    .viz-container {
      background: var(--surface-1);
      border: 1px solid var(--border);
      padding: var(--space-6);
      margin-bottom: var(--space-8);
      transition: background 0.4s ease, border-color 0.4s ease;
    }

    .viz-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--space-6);
    }

    .viz-title {
      font-family: 'Space Grotesk', sans-serif;
      font-weight: 600;
    }

    .progress-bar {
      height: 24px;
      background: var(--surface-2);
      position: relative;
      overflow: hidden;
      transition: background 0.4s ease;
    }

    .progress-fill {
      height: 100%;
      background: var(--primary);
      position: relative;
    }

    .progress-dither {
      position: absolute;
      right: 0;
      top: 0;
      bottom: 0;
      width: 50%;
      display: flex;
    }
    
    /* Create stepped dither zones instead of gradient */
    .progress-dither-zone {
      flex: 1;
      position: relative;
      image-rendering: pixelated;
    }
    
    .progress-dither-zone::after {
      content: '';
      position: absolute;
      inset: 0;
      image-rendering: pixelated;
      image-rendering: crisp-edges;
    }
    
    /* Fallback simple dither for progress bar */
    .progress-dither::after {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(90deg, 
        transparent 0%,
        var(--surface-2) 100%
      );
      /* Overlay a 50% dither pattern */
      mix-blend-mode: normal;
    }
    
    .progress-dither::before {
      content: '';
      position: absolute;
      inset: 0;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='2' height='2'%3E%3Crect x='0' y='0' width='1' height='1' fill='%23000000' fill-opacity='0.5'/%3E%3Crect x='1' y='1' width='1' height='1' fill='%23000000' fill-opacity='0.5'/%3E%3C/svg%3E");
      background-size: var(--dither-size) var(--dither-size);
      image-rendering: pixelated;
      mask-image: linear-gradient(90deg, transparent 0%, black 100%);
      -webkit-mask-image: linear-gradient(90deg, transparent 0%, black 100%);
    }

    .progress-label {
      position: absolute;
      right: var(--space-3);
      top: 50%;
      transform: translateY(-50%);
      font-family: 'JetBrains Mono', monospace;
      font-size: 11px;
      color: var(--text-secondary);
    }

    /* ================================
       HEATMAP
    ================================ */
    
    .viz-grid {
      display: grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 2px;
    }

    .viz-cell {
      aspect-ratio: 1;
      background: var(--surface-2);
      transition: all 0.2s ease;
    }

    /* Levels computed dynamically via inline styles */

    .viz-cell.dither-1,
    .viz-cell.dither-2,
    .viz-cell.dither-3 {
      position: relative;
      overflow: hidden;
    }

    .viz-cell.dither-1::after,
    .viz-cell.dither-2::after,
    .viz-cell.dither-3::after {
      content: '';
      position: absolute;
      inset: 0;
      image-rendering: pixelated;
      image-rendering: crisp-edges;
      background-size: var(--dither-size) var(--dither-size);
    }
    
    /* 25% density - sparse dots */
    .viz-cell.dither-1::after {
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='4' height='4'%3E%3Crect x='0' y='0' width='1' height='1' fill='var(--dither-color,white)'/%3E%3C/svg%3E");
      opacity: var(--dither-opacity, 0.4);
    }
    
    /* 50% density - checkerboard */
    .viz-cell.dither-2::after {
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='2' height='2'%3E%3Crect x='0' y='0' width='1' height='1' fill='white'/%3E%3Crect x='1' y='1' width='1' height='1' fill='white'/%3E%3C/svg%3E");
      opacity: var(--dither-opacity, 0.5);
    }
    
    /* 75% density - inverse sparse */
    .viz-cell.dither-3::after {
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='4' height='4'%3E%3Crect x='0' y='0' width='1' height='1' fill='white'/%3E%3Crect x='2' y='0' width='1' height='1' fill='white'/%3E%3Crect x='1' y='1' width='1' height='1' fill='white'/%3E%3Crect x='3' y='1' width='1' height='1' fill='white'/%3E%3Crect x='0' y='2' width='1' height='1' fill='white'/%3E%3Crect x='2' y='2' width='1' height='1' fill='white'/%3E%3Crect x='1' y='3' width='1' height='1' fill='white'/%3E%3Crect x='3' y='3' width='1' height='1' fill='white'/%3E%3C/svg%3E");
      opacity: var(--dither-opacity, 0.6);
    }

    /* ================================
       DATA TABLE
    ================================ */
    
    .table-container {
      background: var(--surface-1);
      border: 1px solid var(--border);
      margin-bottom: var(--space-8);
      transition: background 0.4s ease, border-color 0.4s ease;
    }

    .table-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: var(--space-4) var(--space-6);
      border-bottom: 1px solid var(--border);
    }

    .table-title {
      font-family: 'Space Grotesk', sans-serif;
      font-weight: 600;
      font-size: var(--text-base);
    }

    .table {
      width: 100%;
      border-collapse: collapse;
    }

    .table th {
      font-family: 'JetBrains Mono', monospace;
      font-size: var(--text-xs);
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-tertiary);
      text-align: left;
      padding: var(--space-3) var(--space-4);
      border-bottom: 1px solid var(--border);
      background: var(--surface-2);
      transition: background 0.4s ease;
    }

    .table td {
      padding: var(--space-3) var(--space-4);
      font-size: var(--text-sm);
      border-bottom: 1px solid var(--surface-2);
    }

    .table tr:hover td {
      background: var(--surface-2);
    }

    .table-id {
      font-family: 'JetBrains Mono', monospace;
      font-size: var(--text-xs);
      color: var(--text-tertiary);
    }

    /* ================================
       RIGHT PANEL
    ================================ */
    
    .panel {
      background: var(--surface-1);
      display: flex;
      flex-direction: column;
      transition: background 0.4s ease;
    }

    .panel-header {
      padding: var(--space-4) var(--space-4);
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .panel-title {
      font-family: 'JetBrains Mono', monospace;
      font-size: var(--text-xs);
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--text-tertiary);
    }

    .panel-content {
      padding: var(--space-4);
      flex: 1;
      overflow-y: auto;
    }

    .panel-section {
      margin-bottom: var(--space-6);
    }

    .panel-section-title {
      font-size: var(--text-xs);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-tertiary);
      margin-bottom: var(--space-3);
      padding-bottom: var(--space-2);
      border-bottom: 1px solid var(--border);
    }

    .info-block {
      padding: var(--space-3);
      margin-bottom: var(--space-2);
      background: var(--surface-2);
      position: relative;
      transition: background 0.4s ease;
    }

    .info-block.dithered::after {
      content: '';
      position: absolute;
      inset: 0;
      pointer-events: none;
      background-size: var(--dither-size) var(--dither-size);
      background-image: 
        radial-gradient(circle at 25% 25%, var(--text-primary) 1px, transparent 1px),
        radial-gradient(circle at 75% 75%, var(--text-primary) 1px, transparent 1px);
      opacity: 0.06;
    }

    .info-label {
      font-family: 'JetBrains Mono', monospace;
      font-size: 10px;
      color: var(--text-tertiary);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: var(--space-1);
    }

    .info-value {
      font-size: var(--text-sm);
      color: var(--text-secondary);
    }

    .info-value.mono {
      font-family: 'JetBrains Mono', monospace;
    }

    .info-value.highlight {
      color: var(--primary);
      font-weight: 600;
    }

    .activity-item {
      display: flex;
      gap: var(--space-3);
      padding: var(--space-3) 0;
      border-bottom: 1px solid var(--surface-2);
      font-size: var(--text-sm);
    }

    .activity-time {
      font-family: 'JetBrains Mono', monospace;
      font-size: 10px;
      color: var(--text-tertiary);
      white-space: nowrap;
    }

    .activity-text {
      color: var(--text-secondary);
    }

    .activity-text strong {
      color: var(--primary);
      font-weight: 500;
    }

    /* ================================
       FOOTER
    ================================ */
    
    .footer {
      grid-column: 1 / -1;
      background: var(--surface-2);
      padding: var(--space-2) var(--space-6);
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-family: 'JetBrains Mono', monospace;
      font-size: 11px;
      color: var(--text-tertiary);
      border-top: 1px solid var(--border);
      transition: background 0.4s ease, border-color 0.4s ease;
    }

    .footer-left {
      display: flex;
      gap: var(--space-6);
    }

    .footer-item {
      display: flex;
      align-items: center;
      gap: var(--space-2);
    }

    /* ================================
       RESPONSIVE
    ================================ */
    
    @media (max-width: 1400px) {
      .interface {
        margin-right: 0;
      }
      .control-panel {
        position: static;
        width: 100%;
        max-height: none;
        margin-bottom: 1px;
      }
      .interface {
        grid-template-columns: 200px 1fr;
      }
      .panel {
        display: none;
      }
    }

    @media (max-width: 768px) {
      .interface {
        grid-template-columns: 1fr;
      }
      .nav {
        display: none;
      }
    }
  </style>
</head>
<body>
  <!-- Control Panel -->
  <div class="control-panel" id="controlPanel">
    <div class="control-panel-header">
      <span class="control-panel-title">System Controls</span>
      <button class="control-toggle" onclick="togglePanel()">—</button>
    </div>

    <div id="controlContent">
      <!-- Mode Selector -->
      <div class="control-section">
        <div class="control-section-title">Environment Mode</div>
        
        <div class="mode-selector">
          <button class="mode-option dark selected" data-mode="dark" onclick="setMode('dark')">
            <span class="mode-option-label">Dark</span>
            <span class="mode-option-time">23:00</span>
          </button>
          <button class="mode-option twilight" data-mode="twilight" onclick="setMode('twilight')">
            <span class="mode-option-label">Twilight</span>
            <span class="mode-option-time">18:30</span>
          </button>
          <button class="mode-option light" data-mode="light" onclick="setMode('light')">
            <span class="mode-option-label">Light</span>
            <span class="mode-option-time">12:00</span>
          </button>
        </div>

        <div class="mode-preview" id="modePreview">
          <div class="mode-preview-bg" id="previewBg">
            BG
            <div class="mode-preview-fg">
              <div class="mode-preview-swatch" id="previewFg1"></div>
              <div class="mode-preview-swatch" id="previewFg2"></div>
              <div class="mode-preview-swatch" id="previewFg3"></div>
            </div>
          </div>
        </div>

        <div class="harmony-info">
          <div class="harmony-row">
            <span>BG Hue Shift</span>
            <span class="harmony-value" id="harmonyBgShift">+0°</span>
          </div>
          <div class="harmony-row">
            <span>FG Hue Shift</span>
            <span class="harmony-value" id="harmonyFgShift">+0°</span>
          </div>
          <div class="harmony-row">
            <span>Contrast Ratio</span>
            <span class="harmony-value" id="harmonyContrast">~12:1</span>
          </div>
        </div>
      </div>

      <!-- Background Control -->
      <div class="control-section">
        <div class="control-section-title">Background Tone</div>
        
        <label class="control-label">Hue (30° steps)</label>
        <div class="hue-grid" id="bgHueGrid"></div>

        <label class="control-label">Saturation</label>
        <div class="sat-grid" id="bgSatGrid"></div>

        <label class="control-label">Lightness</label>
        <div class="light-grid" id="bgLightGrid"></div>

        <div class="color-preview compact">
          <div class="color-swatch" id="bgColorSwatch"></div>
          <div class="color-values">
            <span class="color-hex" id="bgColorHex">#1A1816</span>
            <span id="bgColorHSL">H:20 S:8 L:10</span>
          </div>
        </div>
      </div>

      <!-- Text/Foreground Control -->
      <div class="control-section">
        <div class="control-section-title">Text Tone</div>
        
        <label class="control-label">Hue (30° steps)</label>
        <div class="hue-grid" id="fgHueGrid"></div>

        <label class="control-label">Saturation</label>
        <div class="sat-grid" id="fgSatGrid"></div>

        <div class="color-preview compact">
          <div class="color-swatch" id="fgColorSwatch"></div>
          <div class="color-values">
            <span class="color-hex" id="fgColorHex">#D9D0C7</span>
            <span id="fgColorHSL">H:30 S:15 L:85</span>
          </div>
        </div>
      </div>

      <!-- HSV Color Picker -->
      <div class="control-section">
        <div class="control-section-title">Primary Accent</div>
        
        <label class="control-label">Hue (30° steps)</label>
        <div class="hue-grid" id="hueGrid"></div>

        <label class="control-label">Saturation / Lightness</label>
        <div class="sv-grid" id="svGrid"></div>

        <div class="color-preview">
          <div class="color-swatch" id="colorSwatch"></div>
          <div class="color-values">
            <span class="color-hex" id="colorHex">#FF6B35</span>
            <span id="colorHSL">H:18 S:100 L:60</span>
          </div>
        </div>
      </div>

      <!-- DPI Controls -->
      <div class="control-section">
        <div class="control-section-title">Dither Density</div>
        
        <div class="dpi-options">
          <div class="dpi-option selected" data-dpi="fine" onclick="setDPI('fine')">
            <span class="dpi-option-label">FINE</span>
            <span class="dpi-option-desc">4px</span>
          </div>
          <div class="dpi-option" data-dpi="retina" onclick="setDPI('retina')">
            <span class="dpi-option-label">RETINA</span>
            <span class="dpi-option-desc">2px</span>
          </div>
        </div>

        <div class="dpi-preview">
          <div class="dpi-preview-label">DITHER PREVIEW</div>
          <div class="dpi-preview-bar">
            <div class="dpi-preview-fill">
              <div class="progress-dither"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="interface">
    <!-- Header -->
    <header class="header">
      <div class="logo">
        POST/MODERN
      </div>
      <div class="header-status">
        <div class="status-indicator">
          <span class="status-dot"></span>
          <span>SYSTEM NOMINAL</span>
        </div>
        <span>LAT 47.6°N</span>
        <span>2025.327</span>
        <span id="clock">14:23:07</span>
      </div>
    </header>

    <!-- Navigation -->
    <nav class="nav">
      <div class="nav-section">
        <div class="nav-section-title">Operations</div>
        <a class="nav-item active" href="#">
          <span class="nav-item-icon">◈</span>
          Dashboard
        </a>
        <a class="nav-item" href="#">
          <span class="nav-item-icon">▤</span>
          Data Streams
          <span class="nav-badge active">12</span>
        </a>
        <a class="nav-item" href="#">
          <span class="nav-item-icon">◎</span>
          Processes
        </a>
        <a class="nav-item" href="#">
          <span class="nav-item-icon">⬡</span>
          Clusters
        </a>
      </div>

      <div class="nav-section">
        <div class="nav-section-title">Analysis</div>
        <a class="nav-item" href="#">
          <span class="nav-item-icon">▦</span>
          Reports
          <span class="nav-badge">3</span>
        </a>
        <a class="nav-item" href="#">
          <span class="nav-item-icon">◰</span>
          Projections
        </a>
        <a class="nav-item" href="#">
          <span class="nav-item-icon">⊞</span>
          Archives
        </a>
      </div>

      <div class="nav-section">
        <div class="nav-section-title">System</div>
        <a class="nav-item" href="#">
          <span class="nav-item-icon">⚙</span>
          Configuration
        </a>
        <a class="nav-item" href="#">
          <span class="nav-item-icon">◉</span>
          Access Control
        </a>
      </div>
    </nav>

    <!-- Main Content -->
    <main class="main">
      <div class="content-header">
        <div>
          <h1 class="content-title">System Overview</h1>
          <p class="content-subtitle">Real-time operational metrics and status</p>
        </div>
        <div style="display: flex; gap: var(--space-3);">
          <button class="btn btn-secondary">Export</button>
          <button class="btn btn-primary">+ New Process</button>
        </div>
      </div>

      <!-- Metric Cards -->
      <div class="card-grid">
        <div class="card">
          <div class="card-header">
            <span class="card-title">Active Nodes</span>
            <span class="card-status active">Online</span>
          </div>
          <div class="card-value">2,847</div>
          <div class="card-label">Distributed across 12 regions</div>
          <div class="card-footer">↑ 124 since last cycle</div>
        </div>

        <div class="card">
          <div class="card-header">
            <span class="card-title">Throughput</span>
            <span class="card-status pending">Elevated</span>
          </div>
          <div class="card-value">94.2<span style="font-size: var(--text-lg);">%</span></div>
          <div class="card-label">Current capacity utilization</div>
          <div class="card-footer">Target: 85% optimal</div>
        </div>

        <div class="card">
          <div class="card-header">
            <span class="card-title">Latency</span>
            <span class="card-status info">Nominal</span>
          </div>
          <div class="card-value">12<span style="font-size: var(--text-lg);">ms</span></div>
          <div class="card-label">Average response time</div>
          <div class="card-footer">P99: 47ms</div>
        </div>
      </div>

      <!-- Progress Visualization -->
      <div class="viz-container">
        <div class="viz-header">
          <span class="viz-title">Capacity Allocation</span>
          <span style="font-family: 'JetBrains Mono', monospace; font-size: var(--text-xs); color: var(--text-tertiary);">78% ALLOCATED</span>
        </div>
        <div class="progress-bar">
          <div class="progress-fill" style="width: 78%;">
            <div class="progress-dither"></div>
          </div>
        </div>
      </div>

      <!-- Activity Heatmap -->
      <div class="viz-container">
        <div class="viz-header">
          <span class="viz-title">Activity Distribution</span>
          <button class="btn btn-ghost" onclick="regenerateHeatmap()">◐ Regenerate</button>
        </div>
        <div class="viz-grid" id="heatmap"></div>
      </div>

      <!-- Data Table -->
      <div class="table-container">
        <div class="table-header">
          <span class="table-title">Recent Operations</span>
          <button class="btn btn-ghost">↻ Refresh</button>
        </div>
        <table class="table">
          <thead>
            <tr>
              <th>ID</th>
              <th>Operation</th>
              <th>Node</th>
              <th>Duration</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td class="table-id">OP-7823</td>
              <td>Data aggregation</td>
              <td style="font-family: 'JetBrains Mono', monospace; font-size: var(--text-xs);">us-west-2a</td>
              <td>2.4s</td>
              <td><span class="card-status active">Complete</span></td>
            </tr>
            <tr>
              <td class="table-id">OP-7822</td>
              <td>Index rebuild</td>
              <td style="font-family: 'JetBrains Mono', monospace; font-size: var(--text-xs);">eu-central-1</td>
              <td>18.7s</td>
              <td><span class="card-status pending">Running</span></td>
            </tr>
            <tr>
              <td class="table-id">OP-7821</td>
              <td>Cache invalidation</td>
              <td style="font-family: 'JetBrains Mono', monospace; font-size: var(--text-xs);">ap-south-1</td>
              <td>0.3s</td>
              <td><span class="card-status active">Complete</span></td>
            </tr>
            <tr>
              <td class="table-id">OP-7820</td>
              <td>Batch processing</td>
              <td style="font-family: 'JetBrains Mono', monospace; font-size: var(--text-xs);">us-east-1</td>
              <td>45.2s</td>
              <td><span class="card-status info">Queued</span></td>
            </tr>
          </tbody>
        </table>
      </div>
    </main>

    <!-- Right Panel -->
    <aside class="panel">
      <div class="panel-header">
        <span class="panel-title">Context</span>
        <button class="btn btn-ghost">✕</button>
      </div>
      <div class="panel-content">
        <div class="panel-section">
          <div class="panel-section-title">Selected Node</div>
          <div class="info-block">
            <div class="info-label">Identifier</div>
            <div class="info-value mono">node-2847-alpha</div>
          </div>
          <div class="info-block dithered">
            <div class="info-label">Region</div>
            <div class="info-value">US West (Oregon)</div>
          </div>
          <div class="info-block dithered">
            <div class="info-label">Uptime</div>
            <div class="info-value highlight">99.97%</div>
          </div>
          <div class="info-block">
            <div class="info-label">Last Sync</div>
            <div class="info-value mono">2025-11-27 14:22:58</div>
          </div>
        </div>

        <div class="panel-section">
          <div class="panel-section-title">Activity Log</div>
          <div class="activity-item">
            <span class="activity-time">14:23</span>
            <span class="activity-text"><strong>OP-7823</strong> completed</span>
          </div>
          <div class="activity-item">
            <span class="activity-time">14:22</span>
            <span class="activity-text">Cache layer refreshed</span>
          </div>
          <div class="activity-item">
            <span class="activity-time">14:20</span>
            <span class="activity-text"><strong>3 nodes</strong> joined cluster</span>
          </div>
          <div class="activity-item">
            <span class="activity-time">14:18</span>
            <span class="activity-text">Threshold alert cleared</span>
          </div>
          <div class="activity-item">
            <span class="activity-time">14:15</span>
            <span class="activity-text"><strong>OP-7821</strong> initiated</span>
          </div>
        </div>

        <div class="panel-section">
          <div class="panel-section-title">Quick Actions</div>
          <div style="display: flex; flex-direction: column; gap: var(--space-2);">
            <button class="btn btn-secondary" style="width: 100%; text-align: left;">◈ Inspect Node</button>
            <button class="btn btn-secondary" style="width: 100%; text-align: left;">▤ View Logs</button>
            <button class="btn btn-secondary" style="width: 100%; text-align: left;">⚙ Configuration</button>
          </div>
        </div>
      </div>
    </aside>

    <!-- Footer -->
    <footer class="footer">
      <div class="footer-left">
        <div class="footer-item">
          <span style="color: var(--status-active);">●</span>
          <span>12 STREAMS</span>
        </div>
        <div class="footer-item">
          <span>CPU 34%</span>
        </div>
        <div class="footer-item">
          <span>MEM 8.2/16 GB</span>
        </div>
        <div class="footer-item">
          <span>NET ↑2.4 ↓18.7 MB/s</span>
        </div>
      </div>
      <div>
        POST/MODERN v0.3.0 — Interface System
      </div>
    </footer>
  </div>

  <script>
    // ================================
    // STATE
    // ================================
    
    let currentHue = 18;
    let currentSat = 100;
    let currentLight = 60;
    let currentMode = 'dark';
    let currentDPI = 'fine';
    
    // Background tone controls
    let bgHue = 20;       // User-controlled background hue
    let bgSat = 8;        // User-controlled background saturation
    let bgLight = 10;     // User-controlled background lightness
    
    // Text/foreground tone controls
    let fgHue = 30;       // User-controlled text hue
    let fgSat = 15;       // User-controlled text saturation

    // ================================
    // COLOR HARMONY COMPUTATION
    // ================================
    
    /*
     * Mode definitions with color theory:
     * 
     * DARK MODE:
     * - Background: Very low lightness, slightly warm, desaturated
     * - Foreground: High lightness, neutral to slightly warm
     * - Hue relationship: BG shifts toward primary, FG stays neutral
     * 
     * TWILIGHT MODE (Golden/Blue hour):
     * - Background: Medium lightness with warm bias (golden hour) or cool bias (blue hour)
     * - We use "golden hour" - warm amber backgrounds, cooler shadows
     * - Foreground: Cream/warm white, shadows shift slightly blue
     * - This creates the psychological comfort of sunset
     * 
     * LIGHT MODE:
     * - Background: Very high lightness, warm cream (not pure white)
     * - Foreground: Low lightness, warm browns/charcoals
     * - Paper-like quality, easier on eyes than stark white
     */
    
    const modeConfigs = {
      dark: {
        // Lightness range for dark mode
        lightStops: [5, 8, 10, 12, 15, 18],
        defaultLight: 10,
        
        // Foreground computation  
        fgHueShift: 10,
        fgSaturation: 15,
        fgLightness: 85,
        
        // Surface stepping (how much lighter each level)
        surfaceStep: 3,
        
        // Border contrast (relative to bg)
        borderStep: 12,
        
        // Saturation multiplier for surfaces
        surfaceSatMult: 1.0,
        
        contrastRatio: '~12:1'
      },
      
      twilight: {
        // Lightness range for twilight - medium darks
        lightStops: [12, 16, 20, 25, 30, 35],
        defaultLight: 16,
        bgMinSat: 15,
        
        // Foreground: near-white, crisp
        fgHueShift: 10,
        fgSaturation: 8,
        fgLightness: 96,
        
        surfaceStep: 5,
        borderStep: 15,
        surfaceSatMult: 1.2,
        
        contrastRatio: '~12:1'
      },
      
      light: {
        // Lightness range for light mode
        lightStops: [88, 90, 92, 94, 96, 98],
        defaultLight: 94,
        
        // Foreground: dark, warm
        fgHueShift: 0,
        fgSaturation: 15,
        fgLightness: 15,
        
        surfaceStep: -3,
        borderStep: -15,
        surfaceSatMult: 0.8,
        
        contrastRatio: '~12:1'
      }
    };

    function computeHarmony(primaryHue, mode) {
      const config = modeConfigs[mode];
      
      // Background: use user-controlled values
      let effectiveBgHue = bgHue;
      let effectiveBgSat = bgSat;
      let effectiveBgLight = bgLight;
      
      // Foreground: use user-controlled hue/sat, mode-controlled lightness
      let effectiveFgHue = fgHue;
      let effectiveFgSat = fgSat;
      let effectiveFgLight = config.fgLightness;
      
      // Enforce minimum saturation if specified (twilight needs visible color)
      if (config.bgMinSat !== undefined) {
        effectiveBgSat = Math.max(effectiveBgSat, config.bgMinSat);
      }
      
      // Apply surface saturation multiplier
      const surfaceSat = effectiveBgSat * (config.surfaceSatMult || 1.0);
      
      // Compute border lightness
      const borderL = effectiveBgLight + config.borderStep;
      
      return {
        bg: {
          h: effectiveBgHue,
          s: effectiveBgSat,
          l: effectiveBgLight
        },
        fg: {
          h: effectiveFgHue,
          s: effectiveFgSat,
          l: effectiveFgLight
        },
        border: {
          h: effectiveBgHue,
          s: effectiveBgSat + 2,
          l: Math.max(5, Math.min(95, borderL))
        },
        surface: {
          h: effectiveBgHue,
          s: surfaceSat
        },
        surfaceStep: config.surfaceStep,
        contrastRatio: config.contrastRatio,
        bgHueShift: 0,
        fgHueShift: 0
      };
    }

    function applyHarmony() {
      const harmony = computeHarmony(currentHue, currentMode);
      const root = document.documentElement;
      
      // Apply background values
      root.style.setProperty('--bg-h', harmony.bg.h);
      root.style.setProperty('--bg-s', `${harmony.bg.s}%`);
      root.style.setProperty('--bg-l', `${harmony.bg.l}%`);
      
      // Apply surface saturation (for elevated surfaces)
      root.style.setProperty('--surface-s', `${harmony.surface.s}%`);
      
      // Apply foreground values
      root.style.setProperty('--fg-h', harmony.fg.h);
      root.style.setProperty('--fg-s', `${harmony.fg.s}%`);
      root.style.setProperty('--fg-l', `${harmony.fg.l}%`);
      
      // Apply border values
      root.style.setProperty('--border-h', harmony.border.h);
      root.style.setProperty('--border-s', `${harmony.border.s}%`);
      root.style.setProperty('--border-l', `${harmony.border.l}%`);
      
      // Apply surface stepping
      root.style.setProperty('--surface-step', `${harmony.surfaceStep}%`);
      
      // Update harmony display
      document.getElementById('harmonyBgShift').textContent = `+${harmony.bgHueShift}°`;
      document.getElementById('harmonyFgShift').textContent = 
        harmony.fgHueShift >= 0 ? `+${harmony.fgHueShift}°` : `${harmony.fgHueShift}°`;
      document.getElementById('harmonyContrast').textContent = harmony.contrastRatio;
      
      // Update preview
      updateModePreview(harmony);
      
      // Regenerate heatmap with new colors
      regenerateHeatmap();
    }

    function updateModePreview(harmony) {
      const previewBg = document.getElementById('previewBg');
      const previewFg1 = document.getElementById('previewFg1');
      const previewFg2 = document.getElementById('previewFg2');
      const previewFg3 = document.getElementById('previewFg3');
      
      previewBg.style.background = `hsl(${harmony.bg.h}, ${harmony.bg.s}%, ${harmony.bg.l}%)`;
      previewBg.style.color = `hsl(${harmony.fg.h}, ${harmony.fg.s}%, ${harmony.fg.l}%)`;
      
      previewFg1.style.background = `hsl(${harmony.fg.h}, ${harmony.fg.s}%, ${harmony.fg.l}%)`;
      previewFg2.style.background = `hsl(${harmony.fg.h}, ${harmony.fg.s * 0.6}%, ${harmony.fg.l - 15}%)`;
      previewFg3.style.background = `hsl(${harmony.fg.h}, ${harmony.fg.s * 0.4}%, ${harmony.fg.l - 35}%)`;
    }

    // ================================
    // MODE SELECTION
    // ================================
    
    function setMode(mode) {
      currentMode = mode;
      
      // Update UI
      document.querySelectorAll('.mode-option').forEach(opt => {
        opt.classList.toggle('selected', opt.dataset.mode === mode);
      });
      
      // Set lightness to mode's default
      const config = modeConfigs[mode];
      bgLight = config.defaultLight;
      
      // Reinitialize all background grids
      initBgHueGrid();
      initBgSatGrid();
      initBgLightGrid();
      applyBgPreview();
      
      // Reinitialize foreground grids (lightness changes per mode)
      initFgHueGrid();
      initFgSatGrid();
      applyFgPreview();
      
      // Apply harmony
      applyHarmony();
    }

    // ================================
    // HSV COLOR PICKER (Primary Accent)
    // ================================
    
    function initHueGrid() {
      const grid = document.getElementById('hueGrid');
      grid.innerHTML = '';
      
      for (let i = 0; i < 12; i++) {
        const hue = i * 30;
        const step = document.createElement('div');
        step.className = 'hue-step';
        step.style.background = `hsl(${hue}, 80%, 55%)`;
        step.dataset.hue = hue;
        
        // Check if this hue is selected (within 15 degrees)
        const hueDiff = Math.abs(hue - currentHue);
        if (hueDiff < 15 || hueDiff > 345) {
          step.classList.add('selected');
        }
        
        step.onclick = () => selectHue(hue);
        grid.appendChild(step);
      }
    }

    function initSVGrid() {
      const grid = document.getElementById('svGrid');
      grid.innerHTML = '';
      
      const saturations = [40, 55, 70, 85, 100, 100];
      const lightnesses = [35, 45, 55, 65];
      
      for (let l = 0; l < lightnesses.length; l++) {
        for (let s = 0; s < saturations.length; s++) {
          const sat = saturations[s];
          const light = lightnesses[l];
          
          const step = document.createElement('div');
          step.className = 'sv-step';
          step.style.background = `hsl(${currentHue}, ${sat}%, ${light}%)`;
          step.dataset.sat = sat;
          step.dataset.light = light;
          
          if (sat === currentSat && light === currentLight) {
            step.classList.add('selected');
          }
          
          step.onclick = () => selectSV(sat, light);
          grid.appendChild(step);
        }
      }
    }

    function selectHue(hue) {
      currentHue = hue;
      initHueGrid();
      initSVGrid();
      applyColor();
      applyHarmony();
    }

    function selectSV(sat, light) {
      currentSat = sat;
      currentLight = light;
      initSVGrid();
      applyColor();
    }

    // ================================
    // BACKGROUND TONE CONTROLS
    // ================================
    
    function initBgHueGrid() {
      const grid = document.getElementById('bgHueGrid');
      grid.innerHTML = '';
      
      for (let i = 0; i < 12; i++) {
        const hue = i * 30;
        const step = document.createElement('div');
        step.className = 'hue-step';
        // Always show at a visible lightness for the picker (not mode-dependent)
        // Use 35% lightness so hues are clearly distinguishable
        step.style.background = `hsl(${hue}, 25%, 35%)`;
        step.dataset.hue = hue;
        
        const hueDiff = Math.abs(hue - bgHue);
        if (hueDiff < 15 || hueDiff > 345) {
          step.classList.add('selected');
        }
        
        step.onclick = () => selectBgHue(hue);
        grid.appendChild(step);
      }
    }

    function initBgSatGrid() {
      const grid = document.getElementById('bgSatGrid');
      grid.innerHTML = '';
      
      // Saturation steps: 0 (neutral) to 30 (quite saturated for a bg)
      const saturations = [0, 6, 12, 18, 24, 30];
      
      for (let i = 0; i < saturations.length; i++) {
        const sat = saturations[i];
        const step = document.createElement('div');
        step.className = 'sat-step';
        // Show at a fixed visible lightness (35%) so saturation differences are clear
        step.style.background = `hsl(${bgHue}, ${sat}%, 35%)`;
        step.dataset.sat = sat;
        
        if (sat === bgSat) {
          step.classList.add('selected');
        }
        
        step.onclick = () => selectBgSat(sat);
        grid.appendChild(step);
      }
    }

    function initBgLightGrid() {
      const grid = document.getElementById('bgLightGrid');
      grid.innerHTML = '';
      
      // Get lightness stops for current mode
      const config = modeConfigs[currentMode];
      const lightStops = config.lightStops;
      
      for (let i = 0; i < lightStops.length; i++) {
        const light = lightStops[i];
        const step = document.createElement('div');
        step.className = 'light-step';
        // Show actual lightness with current hue/sat
        step.style.background = `hsl(${bgHue}, ${bgSat}%, ${light}%)`;
        step.dataset.light = light;
        
        if (light === bgLight) {
          step.classList.add('selected');
        }
        
        step.onclick = () => selectBgLight(light);
        grid.appendChild(step);
      }
    }

    function selectBgHue(hue) {
      bgHue = hue;
      initBgHueGrid();
      initBgSatGrid();
      initBgLightGrid();
      applyBgPreview();
      applyHarmony();
    }

    function selectBgSat(sat) {
      bgSat = sat;
      initBgSatGrid();
      initBgLightGrid();
      applyBgPreview();
      applyHarmony();
    }

    function selectBgLight(light) {
      bgLight = light;
      initBgLightGrid();
      applyBgPreview();
      applyHarmony();
    }

    function applyBgPreview() {
      const swatch = document.getElementById('bgColorSwatch');
      swatch.style.background = `hsl(${bgHue}, ${bgSat}%, ${bgLight}%)`;
      
      document.getElementById('bgColorHSL').textContent = `H:${bgHue} S:${bgSat} L:${bgLight}`;
      document.getElementById('bgColorHex').textContent = hslToHex(bgHue, bgSat, bgLight);
    }

    // ================================
    // TEXT/FOREGROUND TONE CONTROLS
    // ================================
    
    function initFgHueGrid() {
      const grid = document.getElementById('fgHueGrid');
      grid.innerHTML = '';
      
      for (let i = 0; i < 12; i++) {
        const hue = i * 30;
        const step = document.createElement('div');
        step.className = 'hue-step';
        // Show at high lightness since this is for text
        step.style.background = `hsl(${hue}, 30%, 70%)`;
        step.dataset.hue = hue;
        
        const hueDiff = Math.abs(hue - fgHue);
        if (hueDiff < 15 || hueDiff > 345) {
          step.classList.add('selected');
        }
        
        step.onclick = () => selectFgHue(hue);
        grid.appendChild(step);
      }
    }

    function initFgSatGrid() {
      const grid = document.getElementById('fgSatGrid');
      grid.innerHTML = '';
      
      // Wider saturation range for visible difference: 0 to 50
      const saturations = [0, 10, 20, 30, 40, 50];
      
      for (let i = 0; i < saturations.length; i++) {
        const sat = saturations[i];
        const step = document.createElement('div');
        step.className = 'sat-step';
        // Show at medium lightness (60%) so saturation is clearly visible
        step.style.background = `hsl(${fgHue}, ${sat}%, 60%)`;
        step.dataset.sat = sat;
        
        if (sat === fgSat) {
          step.classList.add('selected');
        }
        
        step.onclick = () => selectFgSat(sat);
        grid.appendChild(step);
      }
    }

    function selectFgHue(hue) {
      fgHue = hue;
      initFgHueGrid();
      initFgSatGrid();
      applyFgPreview();
      applyHarmony();
    }

    function selectFgSat(sat) {
      fgSat = sat;
      initFgSatGrid();
      applyFgPreview();
      applyHarmony();
    }

    function applyFgPreview() {
      const config = modeConfigs[currentMode];
      const swatch = document.getElementById('fgColorSwatch');
      swatch.style.background = `hsl(${fgHue}, ${fgSat}%, ${config.fgLightness}%)`;
      
      document.getElementById('fgColorHSL').textContent = `H:${fgHue} S:${fgSat} L:${config.fgLightness}`;
      document.getElementById('fgColorHex').textContent = hslToHex(fgHue, fgSat, config.fgLightness);
    }

    function applyColor() {
      const root = document.documentElement;
      
      root.style.setProperty('--primary-h', currentHue);
      root.style.setProperty('--primary-s', `${currentSat}%`);
      root.style.setProperty('--primary-l', `${currentLight}%`);
      
      // Update preview
      const swatch = document.getElementById('colorSwatch');
      swatch.style.background = `hsl(${currentHue}, ${currentSat}%, ${currentLight}%)`;
      
      document.getElementById('colorHSL').textContent = `H:${currentHue} S:${currentSat} L:${currentLight}`;
      document.getElementById('colorHex').textContent = hslToHex(currentHue, currentSat, currentLight);
    }

    function hslToHex(h, s, l) {
      s /= 100;
      l /= 100;
      const a = s * Math.min(l, 1 - l);
      const f = n => {
        const k = (n + h / 30) % 12;
        const color = l - a * Math.max(Math.min(k - 3, 9 - k, 1), -1);
        return Math.round(255 * color).toString(16).padStart(2, '0');
      };
      return `#${f(0)}${f(8)}${f(4)}`.toUpperCase();
    }

    // ================================
    // DPI CONTROLS
    // ================================
    
    function setDPI(level) {
      currentDPI = level;
      
      document.querySelectorAll('.dpi-option').forEach(opt => {
        opt.classList.toggle('selected', opt.dataset.dpi === level);
      });
      
      document.body.classList.remove('dpi-fine', 'dpi-retina');
      document.body.classList.add(`dpi-${level}`);
      
      regenerateHeatmap();
    }

    // ================================
    // HEATMAP
    // ================================
    
    function regenerateHeatmap() {
      const heatmap = document.getElementById('heatmap');
      heatmap.innerHTML = '';
      
      const harmony = computeHarmony(currentHue, currentMode);
      
      // Generate color levels based on current harmony
      const levels = generateHeatmapLevels(harmony);
      
      for (let i = 0; i < 84; i++) {
        const cell = document.createElement('div');
        cell.className = 'viz-cell';
        
        const row = Math.floor(i / 12);
        const col = i % 12;
        
        const centerDist = Math.sqrt(Math.pow(col - 6, 2) + Math.pow(row - 3.5, 2));
        const noise = Math.random() * 3;
        const value = Math.max(0, Math.min(levels.length - 1, 
          Math.floor(levels.length - 1 - centerDist * 1.2 + noise)
        ));
        
        const level = levels[value];
        cell.style.background = level.color;
        
        if (level.dither) {
          cell.classList.add(level.dither);
          if (level.ditherOpacity) {
            cell.style.setProperty('--dither-opacity', level.ditherOpacity);
          }
        }
        
        heatmap.appendChild(cell);
      }
    }

    function generateHeatmapLevels(harmony) {
      const bgL = harmony.bg.l;
      const isLight = bgL > 50;
      
      // Generate levels from background toward primary
      const levels = [];
      
      // Base levels (background variations) - solid colors
      for (let i = 0; i < 3; i++) {
        const step = isLight ? -3 : 4;
        levels.push({
          color: `hsl(${harmony.bg.h}, ${harmony.bg.s}%, ${bgL + step * (i + 1)}%)`
        });
      }
      
      // Dithered transitions - use base color with dither overlay
      // The dither adds white pixels at varying densities
      levels.push({
        color: `hsl(${currentHue}, ${currentSat * 0.3}%, ${isLight ? currentLight * 0.9 : currentLight * 0.4}%)`,
        dither: 'dither-1',
        ditherOpacity: 0.3
      });
      
      levels.push({
        color: `hsl(${currentHue}, ${currentSat * 0.5}%, ${isLight ? currentLight * 0.85 : currentLight * 0.5}%)`,
        dither: 'dither-2',
        ditherOpacity: 0.25
      });
      
      levels.push({
        color: `hsl(${currentHue}, ${currentSat * 0.7}%, ${isLight ? currentLight * 0.8 : currentLight * 0.6}%)`,
        dither: 'dither-3',
        ditherOpacity: 0.2
      });
      
      // Solid primary variations
      levels.push({
        color: `hsl(${currentHue}, ${currentSat * 0.8}%, ${currentLight * 0.85}%)`
      });
      
      levels.push({
        color: `hsl(${currentHue}, ${currentSat}%, ${currentLight}%)`
      });
      
      return levels;
    }

    // ================================
    // PANEL TOGGLE
    // ================================
    
    function togglePanel() {
      const content = document.getElementById('controlContent');
      const btn = document.querySelector('.control-toggle');
      
      if (content.style.display === 'none') {
        content.style.display = 'block';
        btn.textContent = '—';
      } else {
        content.style.display = 'none';
        btn.textContent = '+';
      }
    }

    // ================================
    // CLOCK
    // ================================
    
    function updateClock() {
      const now = new Date();
      document.getElementById('clock').textContent = now.toTimeString().slice(0, 8);
    }

    // ================================
    // INIT
    // ================================
    
    // Primary accent controls
    initHueGrid();
    initSVGrid();
    applyColor();
    
    // Background tone controls
    initBgHueGrid();
    initBgSatGrid();
    initBgLightGrid();
    applyBgPreview();
    
    // Text/foreground tone controls
    initFgHueGrid();
    initFgSatGrid();
    applyFgPreview();
    
    // Mode and DPI
    setMode('dark');
    setDPI('fine');
    setInterval(updateClock, 1000);
  </script>
</body>
</html>
